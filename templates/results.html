{% extends "base.html" %}

{% block title %}Sonuçlar - Context Engineering PRP Generator{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h4><i class="fas fa-file-alt me-2"></i>Üretilen PRP Dosyası</h4>
        <p class="text-muted mb-0">Projeniz için oluşturulan PRP dosyasını görüntüleyin ve indirin</p>
    </div>
    <div class="card-body">
        <!-- Dosya Bilgileri -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6><i class="fas fa-info-circle me-2"></i>Dosya Bilgileri</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Dosya Adı:</strong> <span id="fileName">prp_document.md</span></p>
                        <p><strong>Boyut:</strong> <span id="fileSize">-</span></p>
                        <p><strong>Oluşturulma:</strong> <span id="createdAt">{{ session.generated_at or 'Şimdi' }}</span></p>
                        <p><strong>Format:</strong> <span id="fileFormat">Markdown</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6><i class="fas fa-chart-pie me-2"></i>İçerik Özeti</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Bölüm Sayısı:</strong> <span id="sectionCount">-</span></p>
                        <p><strong>Kelime Sayısı:</strong> <span id="wordCount">-</span></p>
                        <p><strong>Satır Sayısı:</strong> <span id="lineCount">-</span></p>
                        <p><strong>Karakter Sayısı:</strong> <span id="charCount">-</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-white">
                        <h6><i class="fas fa-download me-2"></i>İndirme Seçenekleri</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="downloadMd">
                                <i class="fas fa-file-code me-2"></i>Markdown (.md)
                            </button>
                            <button class="btn btn-outline-primary" id="downloadTxt">
                                <i class="fas fa-file-alt me-2"></i>Plain Text (.txt)
                            </button>
                            <button class="btn btn-outline-primary" id="downloadJson">
                                <i class="fas fa-file-code me-2"></i>JSON (.json)
                            </button>
                            <button class="btn btn-outline-primary" id="downloadPdf">
                                <i class="fas fa-file-pdf me-2"></i>PDF (.pdf)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- İçerik Önizleme -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-eye me-2"></i>İçerik Önizleme</h6>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="rawView">
                        <i class="fas fa-code me-1"></i>Ham
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" id="renderedView">
                        <i class="fas fa-eye me-1"></i>Render
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Ham İçerik -->
                <div id="rawContent" style="display: none;">
                    <pre class="bg-light p-3" style="max-height: 600px; overflow-y: auto; border-radius: 5px;"><code id="rawCode">{{ session.generated_content or 'İçerik yükleniyor...' }}</code></pre>
                </div>
                
                <!-- Render Edilmiş İçerik -->
                <div id="renderedContent">
                    <div class="markdown-content" id="markdownContent" style="max-height: 600px; overflow-y: auto;">
                        {{ session.generated_content_html or '<p>İçerik yükleniyor...</p>' | safe }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Paylaşım ve Dışa Aktarma -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-share-alt me-2"></i>Paylaşım ve Dışa Aktarma</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Paylaşım</h6>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-outline-primary" id="copyLink">
                                <i class="fas fa-link me-2"></i>Link Kopyala
                            </button>
                            <button class="btn btn-outline-primary" id="copyContent">
                                <i class="fas fa-copy me-2"></i>İçerik Kopyala
                            </button>
                            <button class="btn btn-outline-primary" id="shareEmail">
                                <i class="fas fa-envelope me-2"></i>E-posta Gönder
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Dışa Aktarma</h6>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-outline-success" id="exportGithub">
                                <i class="fab fa-github me-2"></i>GitHub
                            </button>
                            <button class="btn btn-outline-success" id="exportNotion">
                                <i class="fas fa-sticky-note me-2"></i>Notion
                            </button>
                            <button class="btn btn-outline-success" id="exportConfluence">
                                <i class="fas fa-confluence me-2"></i>Confluence
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geri Bildirim -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-star me-2"></i>Geri Bildirim</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Kalite Değerlendirmesi</h6>
                        <div class="mb-3">
                            <label class="form-label">Üretilen PRP'nin kalitesi nasıl?</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="quality" id="quality1" value="1">
                                <label class="btn btn-outline-danger" for="quality1">1</label>
                                <input type="radio" class="btn-check" name="quality" id="quality2" value="2">
                                <label class="btn btn-outline-warning" for="quality2">2</label>
                                <input type="radio" class="btn-check" name="quality" id="quality3" value="3">
                                <label class="btn btn-outline-info" for="quality3">3</label>
                                <input type="radio" class="btn-check" name="quality" id="quality4" value="4">
                                <label class="btn btn-outline-success" for="quality4">4</label>
                                <input type="radio" class="btn-check" name="quality" id="quality5" value="5">
                                <label class="btn btn-outline-primary" for="quality5">5</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Yorum</h6>
                        <textarea class="form-control" id="feedback" rows="3" placeholder="Önerilerinizi paylaşın..."></textarea>
                        <button class="btn btn-primary mt-2" id="submitFeedback">
                            <i class="fas fa-paper-plane me-2"></i>Gönder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigasyon -->
        <div class="d-flex justify-content-between">
            <a href="/generation" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Önceki Adım
            </a>
            <div>
                <a href="/" class="btn btn-outline-primary me-2">
                    <i class="fas fa-home me-2"></i>Ana Sayfa
                </a>
                <button class="btn btn-success" id="newProject">
                    <i class="fas fa-plus me-2"></i>Yeni Proje
                </button>
            </div>
        </div>
    </div>
</div>

<!-- E-posta Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">E-posta Gönder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="emailTo" class="form-label">Alıcı E-posta</label>
                        <input type="email" class="form-control" id="emailTo" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Konu</label>
                        <input type="text" class="form-control" id="emailSubject" value="PRP Dosyası">
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Mesaj</label>
                        <textarea class="form-control" id="emailMessage" rows="3">Merhaba,

Ekteki PRP dosyasını incelemenizi rica ederim.

İyi çalışmalar.</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="sendEmail">
                    <i class="fas fa-paper-plane me-2"></i>Gönder
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentContent = '';
    
    // İçerik yükle
    loadContent();
    
    // Görünüm değiştirme
    $('#rawView').click(function() {
        $('#renderedContent').hide();
        $('#rawContent').show();
        $(this).addClass('btn-primary').removeClass('btn-outline-primary');
        $('#renderedView').addClass('btn-outline-primary').removeClass('btn-primary');
    });
    
    $('#renderedView').click(function() {
        $('#rawContent').hide();
        $('#renderedContent').show();
        $(this).addClass('btn-primary').removeClass('btn-outline-primary');
        $('#rawView').addClass('btn-outline-primary').removeClass('btn-primary');
    });
    
    // İndirme butonları
    $('#downloadMd').click(() => downloadFile('markdown'));
    $('#downloadTxt').click(() => downloadFile('txt'));
    $('#downloadJson').click(() => downloadFile('json'));
    $('#downloadPdf').click(() => downloadFile('pdf'));
    
    // Paylaşım butonları
    $('#copyLink').click(function() {
        navigator.clipboard.writeText(window.location.href);
        showAlert('success', 'Link kopyalandı!');
    });
    
    $('#copyContent').click(function() {
        navigator.clipboard.writeText(currentContent);
        showAlert('success', 'İçerik kopyalandı!');
    });
    
    $('#shareEmail').click(function() {
        $('#emailModal').modal('show');
    });
    
    // E-posta gönder
    $('#sendEmail').click(function() {
        const formData = {
            to: $('#emailTo').val(),
            subject: $('#emailSubject').val(),
            message: $('#emailMessage').val(),
            content: currentContent
        };
        
        fetch('/api/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'E-posta başarıyla gönderildi!');
                $('#emailModal').modal('hide');
            } else {
                showAlert('danger', 'E-posta gönderme hatası: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'E-posta gönderme hatası: ' + error);
        });
    });
    
    // Geri bildirim gönder
    $('#submitFeedback').click(function() {
        const quality = $('input[name="quality"]:checked').val();
        const feedback = $('#feedback').val();
        
        if (!quality) {
            showAlert('warning', 'Lütfen kalite değerlendirmesi yapın.');
            return;
        }
        
        const feedbackData = {
            quality: parseInt(quality),
            feedback: feedback
        };
        
        fetch('/api/submit-feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(feedbackData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Geri bildiriminiz kaydedildi. Teşekkürler!');
                $('#feedback').val('');
                $('input[name="quality"]').prop('checked', false);
            } else {
                showAlert('danger', 'Geri bildirim gönderme hatası: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'Geri bildirim gönderme hatası: ' + error);
        });
    });
    
    // Yeni proje
    $('#newProject').click(function() {
        if (confirm('Yeni proje başlatmak istediğinizden emin misiniz? Mevcut veriler silinecek.')) {
            fetch('/api/clear-session', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = '/';
            });
        }
    });
    
    // İçerik yükleme fonksiyonu
    function loadContent() {
        fetch('/api/get-generated-content')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentContent = data.content;
                    updateContentInfo(data.content);
                    $('#rawCode').text(data.content);
                    
                    // Markdown render
                    if (data.html) {
                        $('#markdownContent').html(data.html);
                    }
                }
            })
            .catch(error => {
                console.error('İçerik yükleme hatası:', error);
            });
    }
    
    // İçerik bilgilerini güncelle
    function updateContentInfo(content) {
        const lines = content.split('\n').length;
        const words = content.split(/\s+/).length;
        const chars = content.length;
        const sections = (content.match(/^#/gm) || []).length;
        
        $('#lineCount').text(lines);
        $('#wordCount').text(words);
        $('#charCount').text(chars);
        $('#sectionCount').text(sections);
        $('#fileSize').text(formatBytes(chars));
    }
    
    // Dosya boyutu formatla
    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Dosya indirme
    function downloadFile(format) {
        const btn = event.target;
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>İndiriliyor...';
        btn.disabled = true;
        
        fetch('/api/download-file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ format: format })
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prp_${Date.now()}.${format === 'markdown' ? 'md' : format}`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        })
        .catch(error => {
            showAlert('danger', 'İndirme hatası: ' + error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
});
</script>
{% endblock %} 